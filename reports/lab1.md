## 编程作业

首先是对于TaskInfo中的TaskStatus，由于检查的是获取当前正在运行的应用的状态，所以是Running，如果为每个程序添加ID，则可以通过为TaskManager添加函数获取指定程序控制块中的状态。对于syscall_times，可以为每个TaskControlBlock添加syscall_times字段，初始化全0，当应用执行系统调用时，根据系统调用号对指定的index加1。time字段只需要在TaskControlBlock添加start_time字段用于记录程序刚开始运行时的时间，在获取info的时候用当前时间减去开始执行是的时间即可。

## 简答作业

1. 正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。 请同学们可以自行测试这些内容（运行 [三个 bad 测例 (ch2b_bad_*.rs)]）， 描述程序出错行为，同时注意注明你使用的 sbi 及其版本。

[kernel] PageFault in application, bad addr = 0x0, bad instruction = 0x804003a4, kernel killed it.
[kernel] IllegalInstruction in application, kernel killed it.
[kernel] IllegalInstruction in application, kernel killed it.

RustSBI版本：`RustSBI-QEMU Version 0.2.0-alpha.2`

第一个测试样例通过 `write_volatile` 方法向地址 `0x0` 写入数据，访问非法地址，Trap进入内核态，退出当前程序并执行下一个程序。

第二个测试样例中这段代码是在用户态(U态)下尝试执行一个S态的特权指令，导致一个异常，Trap进入内核态，退出当前程序并执行下一个程序。

第三个测试样例的代码尝试在用户模式（U态）下读取`sstatus`寄存器的值。在S态下，操作系统可以访问这个寄存器，但在U态下，尝试访问它通常会导致异常，Trap进入内核态，退出当前程序并执行下一个程序。

2. 深入理解 [trap.S] 中两个函数 `__alltraps` 和 `__restore` 的作用，并回答如下问题:

(1).a0中存放的是`trap_handler`函数的参数，他是一个地址，指向内核栈的栈顶。`__restore`的两种使用情景：启动应用程序时从内核态进入用户态，中断处理完成后返回用户态
(2).sstatus，sepc，sscratch寄存器，sstatus寄存器包含了控制处理器当前状态和特权级的各种标志位，在切换到用户态之前，需要确保这些标志位被正确设置，以反映用户态的执行环境。sepc寄存器保存了导致异常的指令的地址。在从内核态返回到用户态时，需要将这个寄存器设置为用户程序下一个要执行的指令的地址，这样用户程序就可以从正确的位置继续执行。sscratch寄存器通常用于保存用户栈的地址，这样在处理中断或异常时，可以快速地切换到用户栈。在进入用户态之前，需要确保sscratch寄存器包含了正确的用户栈地址，以便在发生中断或异常时能够正确地处理。
(3).x2通常是指sp，而x4通常被用作线程指针，sp已经在前面的代码中被设置为指向内核栈的正确位置，准备释放TrapContext。在恢复上下文时，sp已经指向了内核栈上的TrapContext结构体，因此在从内核栈中恢复其他寄存器值之后，sp需要保持不变，以便正确地释放分配给TrapContext的栈空间。由于x4的值在用户态和内核态之间不需要被保存和恢复，因此在__restore过程中跳过它。
(4).这条指令交换了sp和sscratch的值。在这之前，sp指向内核栈，而sscratch保存了用户栈的地址。执行这条指令之后，sp将指向用户栈，而sscratch将指向内核栈。这样做是为了确保在返回用户态时，栈指针sp指向正确的用户栈。
(5).sret，这是因为sret指令会根据sstatus寄存器中的SPP位来设置新的特权级，并从sepc中读取返回地址。
(6).执行csrrw sp, sscratch, sp之后，sp指向用户栈，而sscratch指向内核栈。
(7).从U态进入S态通常是通过执行ecall指令发生的。

## 荣誉准则
1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

丁煜桐

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

《rCore-Camp-Guide-2024A 文档》

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。

